<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPR Screen Buyback Management System</title>
    
    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #b91c1c;
        }

        /* Smooth Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        /* Button Hover Effects */
        .btn-hover {
            transition: all 0.2s ease;
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-hover:active {
            transform: translateY(0);
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        /* Input Focus Effects */
        input:focus, textarea:focus, select:focus {
            transition: all 0.2s ease;
        }

        /* Smooth page transitions */
        .page-transition {
            animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide Icons as inline SVG components
        const LogIn = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
                <polyline points="10 17 15 12 10 7" />
                <line x1="15" y1="12" x2="3" y2="12" />
            </svg>
        );

        const LogOut = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                <polyline points="16 17 21 12 16 7" />
                <line x1="21" y1="12" x2="9" y2="12" />
            </svg>
        );

        const Plus = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
        );

        const Edit2 = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        );

        const Trash2 = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="3 6 5 6 21 6" />
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                <line x1="10" y1="11" x2="10" y2="17" />
                <line x1="14" y1="11" x2="14" y2="17" />
            </svg>
        );

        const Save = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </svg>
        );

        const TrendingUp = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                <polyline points="17 6 23 6 23 12" />
            </svg>
        );

        const Package = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21" />
                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                <line x1="12" y1="22.08" x2="12" y2="12" />
            </svg>
        );

        const Settings = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="12" cy="12" r="3" />
                <path d="M12 1v6m0 6v6m5.66-13.66l-4.24 4.24m-2.83 2.83l-4.24 4.24M23 12h-6m-6 0H1m16.24-5.66l-4.24 4.24m-2.83 2.83l-4.24 4.24" />
            </svg>
        );

        const UserPlus = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="8.5" cy="7" r="4" />
                <line x1="20" y1="8" x2="20" y2="14" />
                <line x1="23" y1="11" x2="17" y2="11" />
            </svg>
        );

        const Search = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
        );

        const Copy = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
            </svg>
        );

        const Download = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        );

        const BarChart3 = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="12" y1="20" x2="12" y2="10" />
                <line x1="18" y1="20" x2="18" y2="4" />
                <line x1="6" y1="20" x2="6" y2="16" />
            </svg>
        );

        const DollarSign = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="12" y1="1" x2="12" y2="23" />
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
            </svg>
        );

        const Users = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
        );

        const CheckCircle = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
        );

        const ArrowLeft = ({ size = 24, ...props }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
            </svg>
        );

        // Simple localStorage-based storage system
        const createStorage = () => {
            return {
                get: async (key, shared = false) => {
                    try {
                        const value = localStorage.getItem(key);
                        if (value) {
                            return { key, value, shared };
                        }
                        return null;
                    } catch (e) {
                        return null;
                    }
                },
                set: async (key, value, shared = false) => {
                    try {
                        localStorage.setItem(key, value);
                        return { key, value, shared };
                    } catch (e) {
                        return null;
                    }
                }
            };
        };

        // Make storage available globally
        if (!window.storage) {
            window.storage = createStorage();
        }

        const BuybackSystem = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [screen, setScreen] = useState('login');
            const [loginUsername, setLoginUsername] = useState('');
            const [loginPassword, setLoginPassword] = useState('');
            const [loginError, setLoginError] = useState('');
            
            const [users, setUsers] = useState([]);
            const [batches, setBatches] = useState([]);
            const [models, setModels] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [prices, setPrices] = useState({});
            const [currentBatch, setCurrentBatch] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            
            const [showRegister, setShowRegister] = useState(false);
            const [regName, setRegName] = useState('');
            const [regUsername, setRegUsername] = useState('');
            const [regPassword, setRegPassword] = useState('');
            const [regError, setRegError] = useState('');
            
            const [settingsTab, setSettingsTab] = useState('prices');
            const [editPrices, setEditPrices] = useState({});
            const [editModels, setEditModels] = useState([]);
            const [editSuppliers, setEditSuppliers] = useState([]);
            const [newModel, setNewModel] = useState('');
            const [newSupplierName, setNewSupplierName] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [editingSupplier, setEditingSupplier] = useState(null);
            const [editSupplierName, setEditSupplierName] = useState('');
            
            const [isRenamingBatch, setIsRenamingBatch] = useState(false);
            const [tempBatchName, setTempBatchName] = useState('');
            const [isSavingBatch, setIsSavingBatch] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            
            const [isUploadingExcel, setIsUploadingExcel] = useState(false);
            const [uploadMessage, setUploadMessage] = useState('');
            
            const [resettingUserId, setResettingUserId] = useState(null);
            const [newPassword, setNewPassword] = useState('');
            const [regEmail, setRegEmail] = useState('');
            
            const [modelCategory, setModelCategory] = useState('iPhone');
            const [priceCategory, setPriceCategory] = useState('iPhone');
            const [newDeviceCategory, setNewDeviceCategory] = useState('iPhone');

            useEffect(() => {
                loadData();
                // Check for saved login session
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        setCurrentUser(user);
                        setIsAuthenticated(true);
                        setScreen('dashboard');
                    } catch (e) {
                        localStorage.removeItem('currentUser');
                    }
                }
            }, []);

            const loadData = async () => {
                const defaultUsers = [{id:'1',name:'Admin',username:'admin',password:'admin123',role:'admin',createdAt:new Date().toISOString()}];
                const defaultModels = ["iPhone 17 Pro Max","iPhone 17 Pro","iPhone 17 Air","iPhone 17","iPhone 16 Pro Max","iPhone 16 Pro","iPhone 16 Plus","iPhone 16","iPhone 16e","iPhone 15 Pro Max","iPhone 15 Pro","iPhone 15 Plus","iPhone 15","iPhone 14 Pro Max","iPhone 14 Pro","iPhone 14 Plus","iPhone 14","iPhone 13 Pro Max","iPhone 13 Pro","iPhone 13","iPhone 13 Mini","iPhone 12 Pro Max","iPhone 12 / 12 Pro","iPhone 12 Mini","iPhone 11 Pro Max","iPhone 11 Pro","iPhone 11","iPhone XS Max","iPhone XS","iPhone XR","iPhone X","iPhone 8 Plus","iPhone 8","iPhone 7 Plus","iPhone 7","iPhone 6S Plus","iPhone 6S","iPhone 6 Plus","iPhone 6"];
                const defaultSuppliers = [{name:"Injured Gadgets",qualities:["OEM/Refurb","Aftermarket"]},{name:"Mobile Sentrix",qualities:["OEM/Refurb","Aftermarket"]},{name:"Phone LCD Parts",qualities:["OEM/Refurb","Aftermarket"]}];
                const defaultPrices = {"iPhone 17 Pro Max_Injured Gadgets_OEM/Refurb":150.0,"iPhone 17 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 17 Pro Max_Mobile Sentrix_OEM/Refurb":0.0,"iPhone 17 Pro Max_Mobile Sentrix_Aftermarket":0.0,"iPhone 17 Pro Max_Phone LCD Parts_OEM/Refurb":0.0,"iPhone 17 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 17 Pro_Injured Gadgets_OEM/Refurb":125.0,"iPhone 17 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 17 Pro_Mobile Sentrix_OEM/Refurb":0.0,"iPhone 17 Pro_Mobile Sentrix_Aftermarket":0.0,"iPhone 17 Pro_Phone LCD Parts_OEM/Refurb":0.0,"iPhone 17 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 17 Air_Injured Gadgets_OEM/Refurb":100.0,"iPhone 17 Air_Injured Gadgets_Aftermarket":0.0,"iPhone 17 Air_Mobile Sentrix_OEM/Refurb":0.0,"iPhone 17 Air_Mobile Sentrix_Aftermarket":0.0,"iPhone 17 Air_Phone LCD Parts_OEM/Refurb":0.0,"iPhone 17 Air_Phone LCD Parts_Aftermarket":0.0,"iPhone 17_Injured Gadgets_OEM/Refurb":75.0,"iPhone 17_Injured Gadgets_Aftermarket":0.0,"iPhone 17_Mobile Sentrix_OEM/Refurb":0.0,"iPhone 17_Mobile Sentrix_Aftermarket":0.0,"iPhone 17_Phone LCD Parts_OEM/Refurb":0.0,"iPhone 17_Phone LCD Parts_Aftermarket":0.0,"iPhone 16 Pro Max_Injured Gadgets_OEM/Refurb":165.0,"iPhone 16 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 16 Pro Max_Mobile Sentrix_OEM/Refurb":150.0,"iPhone 16 Pro Max_Mobile Sentrix_Aftermarket":5.0,"iPhone 16 Pro Max_Phone LCD Parts_OEM/Refurb":150.0,"iPhone 16 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 16 Pro_Injured Gadgets_OEM/Refurb":105.0,"iPhone 16 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 16 Pro_Mobile Sentrix_OEM/Refurb":100.0,"iPhone 16 Pro_Mobile Sentrix_Aftermarket":3.0,"iPhone 16 Pro_Phone LCD Parts_OEM/Refurb":100.0,"iPhone 16 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 16 Plus_Injured Gadgets_OEM/Refurb":63.0,"iPhone 16 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 16 Plus_Mobile Sentrix_OEM/Refurb":80.0,"iPhone 16 Plus_Mobile Sentrix_Aftermarket":3.0,"iPhone 16 Plus_Phone LCD Parts_OEM/Refurb":80.0,"iPhone 16 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 16_Injured Gadgets_OEM/Refurb":65.0,"iPhone 16_Injured Gadgets_Aftermarket":0.0,"iPhone 16_Mobile Sentrix_OEM/Refurb":23.0,"iPhone 16_Mobile Sentrix_Aftermarket":1.0,"iPhone 16_Phone LCD Parts_OEM/Refurb":80.0,"iPhone 16_Phone LCD Parts_Aftermarket":0.0,"iPhone 16e_Injured Gadgets_OEM/Refurb":26.0,"iPhone 16e_Injured Gadgets_Aftermarket":0.0,"iPhone 16e_Mobile Sentrix_OEM/Refurb":80.0,"iPhone 16e_Mobile Sentrix_Aftermarket":3.0,"iPhone 16e_Phone LCD Parts_OEM/Refurb":0.0,"iPhone 16e_Phone LCD Parts_Aftermarket":0.0,"iPhone 15 Pro Max_Injured Gadgets_OEM/Refurb":123.0,"iPhone 15 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 15 Pro Max_Mobile Sentrix_OEM/Refurb":120.0,"iPhone 15 Pro Max_Mobile Sentrix_Aftermarket":5.0,"iPhone 15 Pro Max_Phone LCD Parts_OEM/Refurb":120.0,"iPhone 15 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 15 Pro_Injured Gadgets_OEM/Refurb":102.0,"iPhone 15 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 15 Pro_Mobile Sentrix_OEM/Refurb":100.0,"iPhone 15 Pro_Mobile Sentrix_Aftermarket":5.0,"iPhone 15 Pro_Phone LCD Parts_OEM/Refurb":100.0,"iPhone 15 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 15 Plus_Injured Gadgets_OEM/Refurb":52.0,"iPhone 15 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 15 Plus_Mobile Sentrix_OEM/Refurb":40.0,"iPhone 15 Plus_Mobile Sentrix_Aftermarket":2.0,"iPhone 15 Plus_Phone LCD Parts_OEM/Refurb":40.0,"iPhone 15 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 15_Injured Gadgets_OEM/Refurb":61.0,"iPhone 15_Injured Gadgets_Aftermarket":0.0,"iPhone 15_Mobile Sentrix_OEM/Refurb":45.0,"iPhone 15_Mobile Sentrix_Aftermarket":2.0,"iPhone 15_Phone LCD Parts_OEM/Refurb":45.0,"iPhone 15_Phone LCD Parts_Aftermarket":0.0,"iPhone 14 Pro Max_Injured Gadgets_OEM/Refurb":104.0,"iPhone 14 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 14 Pro Max_Mobile Sentrix_OEM/Refurb":100.0,"iPhone 14 Pro Max_Mobile Sentrix_Aftermarket":5.0,"iPhone 14 Pro Max_Phone LCD Parts_OEM/Refurb":100.0,"iPhone 14 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 14 Pro_Injured Gadgets_OEM/Refurb":75.0,"iPhone 14 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 14 Pro_Mobile Sentrix_OEM/Refurb":68.0,"iPhone 14 Pro_Mobile Sentrix_Aftermarket":2.0,"iPhone 14 Pro_Phone LCD Parts_OEM/Refurb":68.0,"iPhone 14 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 14 Plus_Injured Gadgets_OEM/Refurb":44.0,"iPhone 14 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 14 Plus_Mobile Sentrix_OEM/Refurb":30.0,"iPhone 14 Plus_Mobile Sentrix_Aftermarket":1.0,"iPhone 14 Plus_Phone LCD Parts_OEM/Refurb":30.0,"iPhone 14 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 14_Injured Gadgets_OEM/Refurb":26.0,"iPhone 14_Injured Gadgets_Aftermarket":0.0,"iPhone 14_Mobile Sentrix_OEM/Refurb":23.0,"iPhone 14_Mobile Sentrix_Aftermarket":1.0,"iPhone 14_Phone LCD Parts_OEM/Refurb":23.0,"iPhone 14_Phone LCD Parts_Aftermarket":0.0,"iPhone 13 Pro Max_Injured Gadgets_OEM/Refurb":50.0,"iPhone 13 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 13 Pro Max_Mobile Sentrix_OEM/Refurb":47.0,"iPhone 13 Pro Max_Mobile Sentrix_Aftermarket":0.0,"iPhone 13 Pro Max_Phone LCD Parts_OEM/Refurb":47.0,"iPhone 13 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 13 Pro_Injured Gadgets_OEM/Refurb":44.0,"iPhone 13 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 13 Pro_Mobile Sentrix_OEM/Refurb":40.0,"iPhone 13 Pro_Mobile Sentrix_Aftermarket":0.0,"iPhone 13 Pro_Phone LCD Parts_OEM/Refurb":40.0,"iPhone 13 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 13_Injured Gadgets_OEM/Refurb":26.0,"iPhone 13_Injured Gadgets_Aftermarket":0.0,"iPhone 13_Mobile Sentrix_OEM/Refurb":20.0,"iPhone 13_Mobile Sentrix_Aftermarket":0.0,"iPhone 13_Phone LCD Parts_OEM/Refurb":20.0,"iPhone 13_Phone LCD Parts_Aftermarket":0.0,"iPhone 13 Mini_Injured Gadgets_OEM/Refurb":44.0,"iPhone 13 Mini_Injured Gadgets_Aftermarket":0.0,"iPhone 13 Mini_Mobile Sentrix_OEM/Refurb":28.0,"iPhone 13 Mini_Mobile Sentrix_Aftermarket":0.0,"iPhone 13 Mini_Phone LCD Parts_OEM/Refurb":28.0,"iPhone 13 Mini_Phone LCD Parts_Aftermarket":0.0,"iPhone 12 Pro Max_Injured Gadgets_OEM/Refurb":49.0,"iPhone 12 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 12 Pro Max_Mobile Sentrix_OEM/Refurb":40.0,"iPhone 12 Pro Max_Mobile Sentrix_Aftermarket":0.0,"iPhone 12 Pro Max_Phone LCD Parts_OEM/Refurb":40.0,"iPhone 12 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 12 / 12 Pro_Injured Gadgets_OEM/Refurb":16.0,"iPhone 12 / 12 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 12 / 12 Pro_Mobile Sentrix_OEM/Refurb":13.0,"iPhone 12 / 12 Pro_Mobile Sentrix_Aftermarket":0.0,"iPhone 12 / 12 Pro_Phone LCD Parts_OEM/Refurb":13.0,"iPhone 12 / 12 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 12 Mini_Injured Gadgets_OEM/Refurb":19.0,"iPhone 12 Mini_Injured Gadgets_Aftermarket":0.0,"iPhone 12 Mini_Mobile Sentrix_OEM/Refurb":20.0,"iPhone 12 Mini_Mobile Sentrix_Aftermarket":0.0,"iPhone 12 Mini_Phone LCD Parts_OEM/Refurb":20.0,"iPhone 12 Mini_Phone LCD Parts_Aftermarket":0.0,"iPhone 11 Pro Max_Injured Gadgets_OEM/Refurb":20.0,"iPhone 11 Pro Max_Injured Gadgets_Aftermarket":0.0,"iPhone 11 Pro Max_Mobile Sentrix_OEM/Refurb":17.0,"iPhone 11 Pro Max_Mobile Sentrix_Aftermarket":0.0,"iPhone 11 Pro Max_Phone LCD Parts_OEM/Refurb":17.0,"iPhone 11 Pro Max_Phone LCD Parts_Aftermarket":0.0,"iPhone 11 Pro_Injured Gadgets_OEM/Refurb":15.0,"iPhone 11 Pro_Injured Gadgets_Aftermarket":0.0,"iPhone 11 Pro_Mobile Sentrix_OEM/Refurb":13.0,"iPhone 11 Pro_Mobile Sentrix_Aftermarket":0.0,"iPhone 11 Pro_Phone LCD Parts_OEM/Refurb":13.0,"iPhone 11 Pro_Phone LCD Parts_Aftermarket":0.0,"iPhone 11_Injured Gadgets_OEM/Refurb":3.0,"iPhone 11_Injured Gadgets_Aftermarket":0.0,"iPhone 11_Mobile Sentrix_OEM/Refurb":2.0,"iPhone 11_Mobile Sentrix_Aftermarket":0.0,"iPhone 11_Phone LCD Parts_OEM/Refurb":2.0,"iPhone 11_Phone LCD Parts_Aftermarket":0.0,"iPhone XS Max_Injured Gadgets_OEM/Refurb":16.0,"iPhone XS Max_Injured Gadgets_Aftermarket":0.0,"iPhone XS Max_Mobile Sentrix_OEM/Refurb":16.0,"iPhone XS Max_Mobile Sentrix_Aftermarket":0.0,"iPhone XS Max_Phone LCD Parts_OEM/Refurb":16.0,"iPhone XS Max_Phone LCD Parts_Aftermarket":0.0,"iPhone XS_Injured Gadgets_OEM/Refurb":8.0,"iPhone XS_Injured Gadgets_Aftermarket":0.0,"iPhone XS_Mobile Sentrix_OEM/Refurb":6.0,"iPhone XS_Mobile Sentrix_Aftermarket":0.0,"iPhone XS_Phone LCD Parts_OEM/Refurb":6.0,"iPhone XS_Phone LCD Parts_Aftermarket":0.0,"iPhone XR_Injured Gadgets_OEM/Refurb":2.0,"iPhone XR_Injured Gadgets_Aftermarket":0.0,"iPhone XR_Mobile Sentrix_OEM/Refurb":1.75,"iPhone XR_Mobile Sentrix_Aftermarket":0.0,"iPhone XR_Phone LCD Parts_OEM/Refurb":1.5,"iPhone XR_Phone LCD Parts_Aftermarket":0.0,"iPhone X_Injured Gadgets_OEM/Refurb":8.0,"iPhone X_Injured Gadgets_Aftermarket":0.0,"iPhone X_Mobile Sentrix_OEM/Refurb":6.0,"iPhone X_Mobile Sentrix_Aftermarket":0.0,"iPhone X_Phone LCD Parts_OEM/Refurb":6.0,"iPhone X_Phone LCD Parts_Aftermarket":0.0,"iPhone 8 Plus_Injured Gadgets_OEM/Refurb":2.0,"iPhone 8 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 8 Plus_Mobile Sentrix_OEM/Refurb":3.5,"iPhone 8 Plus_Mobile Sentrix_Aftermarket":0.0,"iPhone 8 Plus_Phone LCD Parts_OEM/Refurb":3.5,"iPhone 8 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 8_Injured Gadgets_OEM/Refurb":1.0,"iPhone 8_Injured Gadgets_Aftermarket":0.0,"iPhone 8_Mobile Sentrix_OEM/Refurb":1.0,"iPhone 8_Mobile Sentrix_Aftermarket":0.0,"iPhone 8_Phone LCD Parts_OEM/Refurb":1.0,"iPhone 8_Phone LCD Parts_Aftermarket":0.0,"iPhone 7 Plus_Injured Gadgets_OEM/Refurb":0.0,"iPhone 7 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 7 Plus_Mobile Sentrix_OEM/Refurb":3.5,"iPhone 7 Plus_Mobile Sentrix_Aftermarket":0.0,"iPhone 7 Plus_Phone LCD Parts_OEM/Refurb":3.5,"iPhone 7 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 7_Injured Gadgets_OEM/Refurb":0.0,"iPhone 7_Injured Gadgets_Aftermarket":0.0,"iPhone 7_Mobile Sentrix_OEM/Refurb":0.25,"iPhone 7_Mobile Sentrix_Aftermarket":0.0,"iPhone 7_Phone LCD Parts_OEM/Refurb":0.5,"iPhone 7_Phone LCD Parts_Aftermarket":0.0,"iPhone 6S Plus_Injured Gadgets_OEM/Refurb":0.0,"iPhone 6S Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 6S Plus_Mobile Sentrix_OEM/Refurb":1.0,"iPhone 6S Plus_Mobile Sentrix_Aftermarket":0.0,"iPhone 6S Plus_Phone LCD Parts_OEM/Refurb":2.0,"iPhone 6S Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 6S_Injured Gadgets_OEM/Refurb":0.0,"iPhone 6S_Injured Gadgets_Aftermarket":0.0,"iPhone 6S_Mobile Sentrix_OEM/Refurb":0.25,"iPhone 6S_Mobile Sentrix_Aftermarket":0.0,"iPhone 6S_Phone LCD Parts_OEM/Refurb":0.5,"iPhone 6S_Phone LCD Parts_Aftermarket":0.0,"iPhone 6 Plus_Injured Gadgets_OEM/Refurb":0.0,"iPhone 6 Plus_Injured Gadgets_Aftermarket":0.0,"iPhone 6 Plus_Mobile Sentrix_OEM/Refurb":0.25,"iPhone 6 Plus_Mobile Sentrix_Aftermarket":0.0,"iPhone 6 Plus_Phone LCD Parts_OEM/Refurb":0.5,"iPhone 6 Plus_Phone LCD Parts_Aftermarket":0.0,"iPhone 6_Injured Gadgets_OEM/Refurb":0.0,"iPhone 6_Injured Gadgets_Aftermarket":0.0,"iPhone 6_Mobile Sentrix_OEM/Refurb":0.25,"iPhone 6_Mobile Sentrix_Aftermarket":0.0,"iPhone 6_Phone LCD Parts_OEM/Refurb":0.5,"iPhone 6_Phone LCD Parts_Aftermarket":0.0};

                setUsers(defaultUsers);
                setModels(defaultModels);
                setSuppliers(defaultSuppliers);
                setBatches([]);
                setPrices(defaultPrices);
                
                setTimeout(async()=>{
                    try{const d=await window.storage.get('users',true);if(d)setUsers(JSON.parse(d.value))}catch(e){}
                    try{const d=await window.storage.get('batches',true);if(d)setBatches(JSON.parse(d.value))}catch(e){}
                    try{const d=await window.storage.get('models',true);if(d)setModels(JSON.parse(d.value))}catch(e){}
                    try{const d=await window.storage.get('suppliers',true);if(d)setSuppliers(JSON.parse(d.value))}catch(e){}
                    try{const d=await window.storage.get('prices',true);if(d)setPrices(JSON.parse(d.value))}catch(e){}
                },100);
                
                setIsLoading(false);
            };

            useEffect(()=>{setEditPrices(prices);setEditModels(models);setEditSuppliers(suppliers)},[prices,models,suppliers]);

            const handleLogin=()=>{
                if(!loginUsername.trim()||!loginPassword.trim()){setLoginError('Please enter username and password');return;}
                const user=users.find(u=>u.username===loginUsername&&u.password===loginPassword);
                if(user){
                    setCurrentUser(user);
                    setIsAuthenticated(true);
                    setScreen('dashboard');
                    setLoginError('');
                    setLoginUsername('');
                    setLoginPassword('');
                    // Save login session
                    localStorage.setItem('currentUser', JSON.stringify(user));
                }else{
                    setLoginError('Invalid username or password');
                }
            };
            
            const handleLogout = () => {
                setIsAuthenticated(false);
                setCurrentUser(null);
                setScreen('login');
                localStorage.removeItem('currentUser');
            };

            const handleRegister=async()=>{
                if(!regName.trim()||!regUsername.trim()||!regPassword.trim()||!regEmail.trim()){setRegError('All fields are required');return;}
                if(users.find(u=>u.username===regUsername)){setRegError('Username already exists');return;}
                if(regPassword.length<6){setRegError('Password must be at least 6 characters');return;}
                if(!regEmail.includes('@')){setRegError('Please enter a valid email');return;}
                const newUser={id:Date.now().toString(),name:regName,username:regUsername,password:regPassword,email:regEmail,role:'user',createdAt:new Date().toISOString()};
                const updatedUsers=[...users,newUser];
                setUsers(updatedUsers);
                await window.storage.set('users',JSON.stringify(updatedUsers),true);
                alert('Account created successfully!');
                setShowRegister(false);setRegName('');setRegUsername('');setRegPassword('');setRegEmail('');setRegError('');
            };

            const saveBatches=async(newBatches)=>{try{await window.storage.set('batches',JSON.stringify(newBatches),true);setBatches(newBatches)}catch(error){console.error('Error:',error)}};

            // Auto-save batch with debounce
            const autoSaveBatch = async (updatedBatch) => {
                setIsSavingBatch(true);
                setSaveMessage('Saving...');
                try {
                    const bs = {...updatedBatch, updatedAt: new Date().toISOString(), updatedBy: currentUser.name};
                    const idx = batches.findIndex(b => b.id === updatedBatch.id);
                    let nb;
                    if (idx >= 0) {
                        nb = [...batches];
                        nb[idx] = bs;
                    } else {
                        nb = [...batches, bs];
                    }
                    await saveBatches(nb);
                    setSaveMessage('Saved ‚úì');
                    setTimeout(() => setSaveMessage(''), 2000);
                } catch (error) {
                    setSaveMessage('Error saving');
                    setTimeout(() => setSaveMessage(''), 2000);
                }
                setIsSavingBatch(false);
            };

            let saveTimeout;
            const debouncedAutoSave = (batch) => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => autoSaveBatch(batch), 1000);
            };

            const createNewBatch=()=>{
                const bn=`B${new Date().getFullYear()}-${String(batches.length+1).padStart(3,'0')}`;
                const nb={id:Date.now().toString(),batchNumber:bn,createdBy:currentUser.name,createdById:currentUser.id,createdAt:new Date().toISOString(),inventory:models.map(m=>({model:m,oem:0,aftermarket:0})),analysis:null};
                setCurrentBatch(nb);
                setScreen('editor');
                // Trigger rename mode immediately for new batches
                setTimeout(() => {
                    setIsRenamingBatch(true);
                    setTempBatchName(bn);
                }, 100);
            };

            const editBatch=(batch)=>{
                // Sync batch inventory with current models - add any new models that don't exist
                const currentModelNames = models.map(m => m);
                const batchModelNames = batch.inventory.map(i => i.model);
                const missingModels = currentModelNames.filter(m => !batchModelNames.includes(m));
                
                const updatedInventory = [
                    ...batch.inventory,
                    ...missingModels.map(m => ({model: m, oem: 0, aftermarket: 0}))
                ];
                
                // Sort inventory to match current models order
                const sortedInventory = currentModelNames.map(modelName => {
                    return updatedInventory.find(i => i.model === modelName) || {model: modelName, oem: 0, aftermarket: 0};
                });
                
                setCurrentBatch({...batch, inventory: sortedInventory});
                setScreen('editor');
            };
            const duplicateBatch=(batch)=>{const bn=`B${new Date().getFullYear()}-${String(batches.length+1).padStart(3,'0')}`;const inv=batch.inventory.map(i=>({model:i.model,oem:i.oem||0,aftermarket:i.aftermarket||0}));const nb={...batch,id:Date.now().toString(),batchNumber:bn,createdBy:currentUser.name,createdById:currentUser.id,createdAt:new Date().toISOString(),inventory:inv,analysis:null};setCurrentBatch(nb);setScreen('editor')};
            const saveBatch=async()=>{if(!currentBatch)return;const bs={...currentBatch,updatedAt:new Date().toISOString(),updatedBy:currentUser.name};const idx=batches.findIndex(b=>b.id===currentBatch.id);let nb;if(idx>=0){nb=[...batches];nb[idx]=bs}else{nb=[...batches,bs]}await saveBatches(nb);alert('Batch saved successfully!');setScreen('dashboard')};
            const deleteBatch=async(batchId)=>{if(!confirm('Delete?'))return;await saveBatches(batches.filter(b=>b.id!==batchId))};

            const runAnalysis=()=>{
                if(!currentBatch)return;
                let opt=0;const alloc={};const tots={};
                suppliers.forEach(s=>{tots[s.name]=0;alloc[s.name]=[]});
                currentBatch.inventory.forEach(item=>{
                    ['OEM/Refurb','Aftermarket'].forEach(q=>{
                        const qty=q==='OEM/Refurb'?item.oem:item.aftermarket;
                        if(qty>0){
                            let bp=0,bs='';
                            suppliers.forEach(sup=>{const pk=`${item.model}_${sup.name}_${q}`;const pr=prices[pk]||0;if(pr>bp){bp=pr;bs=sup.name}});
                            opt+=bp*qty;
                            if(bs){alloc[bs].push({model:item.model,quality:q,quantity:qty,price:bp,total:bp*qty});tots[bs]+=bp*qty}
                        }
                    })
                });
                setCurrentBatch({...currentBatch,analysis:{optimalRevenue:opt,supplierAllocations:alloc,supplierTotals:tots,analyzedAt:new Date().toISOString()}})
            };

            const updateQuantity=(idx,field,value)=>{
                const inv=[...currentBatch.inventory];
                inv[idx][field]=parseInt(value)||0;
                const updatedBatch = {...currentBatch,inventory:inv};
                setCurrentBatch(updatedBatch);
                debouncedAutoSave(updatedBatch);
            };
            const startRenamingBatch = () => {
                setIsRenamingBatch(true);
                setTempBatchName(currentBatch.batchNumber);
            };
            
            const saveBatchName = async () => {
                if (!tempBatchName.trim()) {
                    alert('Batch name cannot be empty');
                    setIsRenamingBatch(false);
                    return;
                }
                const updatedBatch = {...currentBatch, batchNumber: tempBatchName.trim()};
                setCurrentBatch(updatedBatch);
                await autoSaveBatch(updatedBatch);
                setIsRenamingBatch(false);
            };
            
            const cancelRename = () => {
                setIsRenamingBatch(false);
                setTempBatchName('');
            };

            const calculateLiveTotal=()=>{if(!currentBatch)return 0;let t=0;currentBatch.inventory.forEach(item=>{['OEM/Refurb','Aftermarket'].forEach(q=>{const qty=q==='OEM/Refurb'?item.oem:item.aftermarket;if(qty>0){let bp=0;suppliers.forEach(sup=>{const pk=`${item.model}_${sup.name}_${q}`;const pr=prices[pk]||0;if(pr>bp)bp=pr});t+=bp*qty}})});return t};

            const savePrices=async()=>{setIsSaving(true);try{await window.storage.set('prices',JSON.stringify(editPrices),true);setPrices(editPrices);alert('Prices saved!')}catch(e){alert('Error')}setIsSaving(false)};
            const saveModels=async()=>{setIsSaving(true);try{await window.storage.set('models',JSON.stringify(editModels),true);setModels(editModels);alert('Models saved!')}catch(e){alert('Error')}setIsSaving(false)};
            const saveSuppliers=async()=>{setIsSaving(true);try{await window.storage.set('suppliers',JSON.stringify(editSuppliers),true);setSuppliers(editSuppliers);alert('Suppliers saved!')}catch(e){alert('Error')}setIsSaving(false)};
            
            const handlePasswordReset = async (userId) => {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                const newPass = prompt(`Enter new password for ${user.name}:`);
                if (!newPass) return;
                
                if (newPass.length < 6) {
                    alert('Password must be at least 6 characters');
                    return;
                }
                
                const updatedUsers = users.map(u => 
                    u.id === userId ? {...u, password: newPass} : u
                );
                
                setUsers(updatedUsers);
                await window.storage.set('users', JSON.stringify(updatedUsers), true);
                alert(`‚úÖ Password reset for ${user.name}! New password: ${newPass}`);
            };
            
            // Helper function to detect device category
            const getDeviceCategory = (modelName) => {
                const name = modelName.toLowerCase();
                if (name.includes('iphone')) return 'iPhone';
                if (name.includes('samsung') || name.includes('galaxy')) return 'Samsung';
                if (name.includes('pixel') || name.includes('google')) return 'Google';
                return 'Other';
            };
            
            // Get models by category
            const getModelsByCategory = (category) => {
                return editModels.filter(model => getDeviceCategory(model) === category);
            };
            
            const handleExcelUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                    alert('Please upload an Excel file (.xlsx or .xls)');
                    event.target.value = '';
                    return;
                }
                
                setIsUploadingExcel(true);
                setUploadMessage('üìñ Reading Excel file...');
                
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                            
                            setUploadMessage('‚öôÔ∏è Processing data...');
                            
                            const newModels = [];
                            const newPrices = {};
                            
                            // Process rows (skip header row 0)
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                const model = row[0];
                                
                                if (!model || String(model).trim() === '') continue;
                                
                                const modelName = String(model).trim();
                                newModels.push(modelName);
                                
                                // Column B: Injured Gadgets (OEM only)
                                const injuredPrice = row[1];
                                newPrices[`${modelName}_Injured Gadgets_OEM/Refurb`] = (injuredPrice && String(injuredPrice).toUpperCase() !== 'N/A') ? (parseFloat(injuredPrice) || 0) : 0;
                                newPrices[`${modelName}_Injured Gadgets_Aftermarket`] = 0;
                                
                                // Column C: Mobile Sentrix OEM
                                const mobileOEM = row[2];
                                newPrices[`${modelName}_Mobile Sentrix_OEM/Refurb`] = (mobileOEM && String(mobileOEM).toUpperCase() !== 'N/A') ? (parseFloat(mobileOEM) || 0) : 0;
                                
                                // Column D: Mobile Sentrix Aftermarket
                                const mobileAM = row[3];
                                newPrices[`${modelName}_Mobile Sentrix_Aftermarket`] = (mobileAM && String(mobileAM).toUpperCase() !== 'N/A') ? (parseFloat(mobileAM) || 0) : 0;
                                
                                // Column E: Phone LCD Parts (OEM only)
                                const phoneLCD = row[4];
                                newPrices[`${modelName}_Phone LCD Parts_OEM/Refurb`] = (phoneLCD && String(phoneLCD).toUpperCase() !== 'N/A') ? (parseFloat(phoneLCD) || 0) : 0;
                                newPrices[`${modelName}_Phone LCD Parts_Aftermarket`] = 0;
                            }
                            
                            if (newModels.length === 0) {
                                alert('‚ùå No valid data found in Excel file. Please check the format.');
                                setIsUploadingExcel(false);
                                setUploadMessage('');
                                event.target.value = '';
                                return;
                            }
                            
                            setUploadMessage('üíæ Saving to system...');
                            
                            // Merge with existing models (add new, keep existing)
                            const mergedModels = [...new Set([...newModels, ...models])];
                            
                            // Merge prices (Excel overwrites existing for same models, preserves others)
                            const updatedPrices = {...prices, ...newPrices};
                            
                            // Save to storage
                            await window.storage.set('models', JSON.stringify(mergedModels), true);
                            await window.storage.set('prices', JSON.stringify(updatedPrices), true);
                            
                            setModels(mergedModels);
                            setPrices(updatedPrices);
                            setEditModels(mergedModels);
                            setEditPrices(updatedPrices);
                            
                            setUploadMessage('‚úÖ Upload complete!');
                            
                            setTimeout(() => {
                                setUploadMessage('');
                                setIsUploadingExcel(false);
                            }, 3000);
                            
                            alert(`‚úÖ Success!\n\nLoaded ${newModels.length} models\nUpdated ${Object.keys(newPrices).length} prices\n\nYour batches and users are safe!`);
                        } catch (error) {
                            setUploadMessage('‚ùå Error reading file');
                            alert('Error processing Excel file: ' + error.message);
                            setIsUploadingExcel(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    setUploadMessage('‚ùå Error uploading');
                    alert('Error: ' + error.message);
                    setIsUploadingExcel(false);
                }
                
                // Reset file input
                event.target.value = '';
            };

            const addModel=async()=>{
                if(!newModel.trim())return alert('Enter model name');
                if(editModels.includes(newModel.trim()))return alert('Model already exists');
                const updatedModels = [...editModels,newModel.trim()];
                setEditModels(updatedModels);
                setNewModel('');
                try{
                    await window.storage.set('models',JSON.stringify(updatedModels),true);
                    setModels(updatedModels);
                }catch(e){alert('Error saving')}
            };
            const removeModel=async(model)=>{
                if(!confirm(`Remove ${model}?`))return;
                const updatedModels = editModels.filter(m=>m!==model);
                setEditModels(updatedModels);
                try{
                    await window.storage.set('models',JSON.stringify(updatedModels),true);
                    setModels(updatedModels);
                }catch(e){alert('Error saving')}
            };
            const addSupplier=async()=>{
                if(!newSupplierName.trim())return alert('Enter supplier name');
                if(editSuppliers.find(s=>s.name===newSupplierName.trim()))return alert('Supplier exists');
                const updatedSuppliers = [...editSuppliers,{name:newSupplierName.trim(),qualities:['OEM/Refurb','Aftermarket']}];
                setEditSuppliers(updatedSuppliers);
                setNewSupplierName('');
                try{
                    await window.storage.set('suppliers',JSON.stringify(updatedSuppliers),true);
                    setSuppliers(updatedSuppliers);
                }catch(e){alert('Error saving')}
            };
            const removeSupplier=async(supplierName)=>{
                if(!confirm(`Remove ${supplierName}?`))return;
                const updatedSuppliers = editSuppliers.filter(s=>s.name!==supplierName);
                setEditSuppliers(updatedSuppliers);
                try{
                    await window.storage.set('suppliers',JSON.stringify(updatedSuppliers),true);
                    setSuppliers(updatedSuppliers);
                }catch(e){alert('Error saving')}
            };
            
            const startEditingSupplier=(supplier)=>{setEditingSupplier(supplier.name);setEditSupplierName(supplier.name)};
            const saveSupplierNameEdit=async()=>{
                if(!editSupplierName.trim())return alert('Cannot be empty');
                if(editSuppliers.find(s=>s.name===editSupplierName.trim()&&s.name!==editingSupplier))return alert('Name exists');
                const us=editSuppliers.map(s=>s.name===editingSupplier?{...s,name:editSupplierName.trim()}:s);
                const up={...editPrices};
                Object.keys(up).forEach(k=>{if(k.includes(`_${editingSupplier}_`)){const nk=k.replace(`_${editingSupplier}_`,`_${editSupplierName.trim()}_`);up[nk]=up[k];delete up[k]}});
                setEditSuppliers(us);setEditPrices(up);setEditingSupplier(null);setEditSupplierName('');
                await window.storage.set('suppliers',JSON.stringify(us),true);await window.storage.set('prices',JSON.stringify(up),true);setSuppliers(us);setPrices(up);alert('Supplier name updated!')
            };

            const formatPrice=(value)=>{
                // Convert to string and remove any non-digit characters except decimal point
                let cleaned = String(value).replace(/[^\d.]/g, '');
                
                // Handle empty or just decimal point
                if (!cleaned || cleaned === '.') return '0.00';
                
                // Ensure only one decimal point
                const parts = cleaned.split('.');
                if(parts.length > 2) {
                    cleaned = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // Split into before and after decimal
                const [beforeDecimal, afterDecimal] = cleaned.split('.');
                
                // Limit to 6 digits before decimal, remove leading zeros
                let limited = beforeDecimal ? beforeDecimal.slice(0, 6).replace(/^0+/, '') || '0' : '0';
                
                // Parse and format to exactly 2 decimals
                const num = parseFloat(limited + (afterDecimal !== undefined ? '.' + afterDecimal : ''));
                if(isNaN(num)) return '0.00';
                
                return num.toFixed(2);
            };

            const updatePrice=(model,supplier,quality,value)=>{
                const key=`${model}_${supplier}_${quality}`;
                // Store raw value while typing
                setEditPrices({...editPrices,[key]:value});
            };
            
            const handlePriceBlur=(model,supplier,quality)=>{
                const key=`${model}_${supplier}_${quality}`;
                const currentValue = editPrices[key];
                const formatted = formatPrice(String(currentValue || '0'));
                setEditPrices({...editPrices,[key]:parseFloat(formatted)});
            };

            const exportBatchAsPDF = (batch) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Helper function to add table
                const addTable = (headers, rows, startY, options = {}) => {
                    const { columnWidths = [], fontSize = 9, headerColor = [30, 64, 175] } = options;
                    let y = startY;
                    const cellPadding = 3;
                    const rowHeight = 7;
                    const startX = 15;
                    
                    const cols = columnWidths.length > 0 ? columnWidths : headers.map(() => 180 / headers.length);
                    
                    doc.setFillColor(...headerColor);
                    doc.rect(startX, y, cols.reduce((a, b) => a + b, 0), rowHeight, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, 'bold');
                    
                    let x = startX;
                    headers.forEach((header, i) => {
                        doc.text(header, x + cellPadding, y + 5);
                        x += cols[i];
                    });
                    
                    y += rowHeight;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    rows.forEach((row, rowIndex) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        if (rowIndex % 2 === 0) {
                            doc.setFillColor(249, 250, 251);
                            doc.rect(startX, y, cols.reduce((a, b) => a + b, 0), rowHeight, 'F');
                        }
                        
                        doc.setDrawColor(209, 213, 219);
                        x = startX;
                        row.forEach((cell, i) => {
                            doc.rect(startX + cols.slice(0, i).reduce((a, b) => a + b, 0), y, cols[i], rowHeight);
                        });
                        
                        x = startX;
                        row.forEach((cell, i) => {
                            const cellText = String(cell);
                            const isBold = cellText.includes('‚úì') || cellText.includes('BEST');
                            if (isBold) doc.setFont(undefined, 'bold');
                            if (cellText.includes('‚úì')) doc.setTextColor(22, 163, 74);
                            
                            doc.text(cellText, x + cellPadding, y + 5);
                            
                            if (isBold) doc.setFont(undefined, 'normal');
                            if (cellText.includes('‚úì')) doc.setTextColor(0, 0, 0);
                            x += cols[i];
                        });
                        
                        y += rowHeight;
                    });
                    
                    return y + 5;
                };
                
                // Header - Professional blue
                doc.setFillColor(30, 64, 175);
                doc.rect(0, 0, 210, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.text('CPR', 15, 20);
                doc.setFontSize(16);
                doc.text('SCREEN BUYBACK REPORT', 60, 20);
                
                // Batch Info Box
                doc.setFillColor(241, 245, 249);
                doc.rect(15, 40, 180, 20, 'F');
                doc.setDrawColor(148, 163, 184);
                doc.setLineWidth(0.5);
                doc.rect(15, 40, 180, 20);
                
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(batch.batchNumber, 20, 48);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(`Created: ${new Date(batch.createdAt).toLocaleDateString()}`, 20, 53);
                doc.text(`By: ${batch.createdBy}`, 20, 57);
                if (batch.updatedAt) {
                    doc.text(`Updated: ${new Date(batch.updatedAt).toLocaleDateString()}`, 110, 53);
                }
                
                let y = 68;
                
                // SECTION 1: ANALYSIS FIRST
                if (batch.analysis) {
                    doc.setFillColor(220, 252, 231);
                    doc.setDrawColor(22, 163, 74);
                    doc.setLineWidth(1);
                    doc.rect(15, y, 180, 20, 'FD');
                    doc.setTextColor(22, 163, 74);
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('OPTIMAL REVENUE', 20, y + 8);
                    doc.setFontSize(18);
                    doc.text(`$${batch.analysis.optimalRevenue.toFixed(2)}`, 20, y + 16);
                    
                    y += 28;
                    
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text('ALLOCATION SUMMARY', 15, y);
                    y += 8;
                    
                    const sortedSuppliers = Object.entries(batch.analysis.supplierTotals)
                        .filter(([_, t]) => t > 0)
                        .sort((a, b) => b[1] - a[1]);
                    
                    if (sortedSuppliers.length > 0) {
                        const allocationHeaders = ['Supplier', 'Models', 'Qty', 'Amount'];
                        const allocationRows = [];
                        
                        sortedSuppliers.forEach(([supplier, total]) => {
                            const items = batch.analysis.supplierAllocations[supplier] || [];
                            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
                            const modelNames = [...new Set(items.map(i => i.model))].join(', ');
                            
                            // Split long model names into multiple lines for text wrapping
                            const maxCharsPerLine = 50;
                            const words = modelNames.split(', ');
                            let lines = [];
                            let currentLine = '';
                            
                            words.forEach((word) => {
                                const testLine = currentLine ? currentLine + ', ' + word : word;
                                if (testLine.length > maxCharsPerLine && currentLine) {
                                    lines.push(currentLine);
                                    currentLine = word;
                                } else {
                                    currentLine = testLine;
                                }
                            });
                            if (currentLine) lines.push(currentLine);
                            
                            // Add rows for this supplier (one row per line of models)
                            lines.forEach((line, lineIdx) => {
                                allocationRows.push([
                                    lineIdx === 0 ? supplier : '',
                                    line,
                                    lineIdx === 0 ? String(totalQty) : '',
                                    lineIdx === 0 ? `$${total.toFixed(2)}` : ''
                                ]);
                            });
                        });
                        
                        y = addTable(allocationHeaders, allocationRows, y, {
                            columnWidths: [38, 92, 20, 30],
                            fontSize: 8,
                            headerColor: [30, 64, 175]
                        });
                    }
                    
                    y += 10;
                }
                
                // SECTION 2: Inventory Summary
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(30, 64, 175);
                doc.text('INVENTORY SUMMARY', 15, y);
                y += 8;
                
                const inventoryHeaders = ['Model', 'OEM/Refurb', 'Aftermarket', 'Total Units'];
                const inventoryRows = batch.inventory
                    .filter(item => item.oem > 0 || item.aftermarket > 0)
                    .map(item => [
                        item.model,
                        String(item.oem || 0),
                        String(item.aftermarket || 0),
                        String((item.oem || 0) + (item.aftermarket || 0))
                    ]);
                
                if (inventoryRows.length > 0) {
                    y = addTable(inventoryHeaders, inventoryRows, y, {
                        columnWidths: [80, 30, 30, 30],
                        fontSize: 9,
                        headerColor: [30, 64, 175]
                    });
                } else {
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(100, 100, 100);
                    doc.text('No inventory items', 20, y);
                    y += 10;
                }
                
                // SECTION 3: Detailed Pricing Analysis
                if (batch.analysis) {
                    y += 10;
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text('DETAILED PRICING ANALYSIS', 15, y);
                    y += 8;
                    
                    batch.inventory.forEach(item => {
                        ['OEM/Refurb', 'Aftermarket'].forEach(quality => {
                            const qty = quality === 'OEM/Refurb' ? item.oem : item.aftermarket;
                            if (qty > 0) {
                                if (y > 260) {
                                    doc.addPage();
                                    y = 20;
                                }
                                
                                doc.setFontSize(10);
                                doc.setFont(undefined, 'bold');
                                doc.setTextColor(0, 0, 0);
                                doc.text(`${item.model} - ${quality} (${qty} units)`, 20, y);
                                y += 6;
                                
                                const supplierPrices = [];
                                let bestPrice = 0;
                                let bestSupplier = '';
                                
                                suppliers.forEach(sup => {
                                    const priceKey = `${item.model}_${sup.name}_${quality}`;
                                    const price = prices[priceKey] || 0;
                                    supplierPrices.push({
                                        name: sup.name,
                                        price: price,
                                        total: price * qty
                                    });
                                    if (price > bestPrice) {
                                        bestPrice = price;
                                        bestSupplier = sup.name;
                                    }
                                });
                                
                                const comparisonHeaders = ['Supplier', 'Price/Unit', 'Total', 'Status'];
                                const comparisonRows = supplierPrices.map(sp => [
                                    sp.name,
                                    `$${sp.price.toFixed(2)}`,
                                    `$${sp.total.toFixed(2)}`,
                                    sp.name === bestSupplier ? '‚úì BEST' : ''
                                ]);
                                
                                y = addTable(comparisonHeaders, comparisonRows, y, {
                                    columnWidths: [60, 30, 30, 30],
                                    fontSize: 8,
                                    headerColor: [71, 85, 105]
                                });
                                
                                y += 3;
                            }
                        });
                    });
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(`CPR Buyback Management System | ${new Date().toLocaleDateString()}`, 15, 290);
                    doc.text(`Page ${i} of ${pageCount}`, 180, 290);
                }
                
                const fileName = `${batch.batchNumber.replace(/[^a-zA-Z0-9-_]/g, '_')}_Report.pdf`;
                doc.save(fileName);
            };
            const filteredBatches=batches.filter(batch=>batch.batchNumber.toLowerCase().includes(searchTerm.toLowerCase())||batch.createdBy.toLowerCase().includes(searchTerm.toLowerCase())).reverse();
            const getDashboardStats=()=>{const totalBatches=batches.length;const analyzedBatches=batches.filter(b=>b.analysis).length;const totalRevenue=batches.reduce((sum,b)=>sum+(b.analysis?.optimalRevenue||0),0);const recentBatches=batches.slice(-5).reverse();return{totalBatches,analyzedBatches,totalRevenue,recentBatches}};

            if(!isAuthenticated){
                return(
                    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-red-600 animate-scale-in">
                            {!showRegister?(
                                <>
                                    <div className="text-center mb-8">
                                        <div className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg animate-scale-in">
                                            <span className="text-white font-bold text-2xl">CPR</span>
                                        </div>
                                        <h1 className="text-3xl font-bold text-gray-800">CPR Buyback</h1>
                                        <p className="text-gray-600 mt-2">Screen Buyback Management</p>
                                    </div>
                                    <div className="space-y-4">
                                        <input type="text" value={loginUsername} onChange={e=>setLoginUsername(e.target.value)} placeholder="Username" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
                                        <input type="password" value={loginPassword} onChange={e=>setLoginPassword(e.target.value)} placeholder="Password" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
                                        {loginError&&<div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm animate-slide-in">{loginError}</div>}
                                        <button onClick={handleLogin} className="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-lg flex items-center justify-center gap-2 btn-hover"><LogIn size={20}/>Login</button>
                                        <button onClick={()=>setShowRegister(true)} className="w-full text-red-600 font-medium flex items-center justify-center gap-2 pt-4 border-t hover:text-red-700 transition-colors"><UserPlus size={18}/>Create New Account</button>
                                    </div>
                                </>
                            ):(
                                <>
                                    <div className="text-center mb-6"><h2 className="text-2xl font-bold">Create Account</h2></div>
                                    <div className="space-y-4">
                                        <input type="text" value={regName} onChange={e=>setRegName(e.target.value)} placeholder="Full Name" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all"/>
                                        <input type="email" value={regEmail} onChange={e=>setRegEmail(e.target.value)} placeholder="Email" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all"/>
                                        <input type="text" value={regUsername} onChange={e=>setRegUsername(e.target.value)} placeholder="Username" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all"/>
                                        <input type="password" value={regPassword} onChange={e=>setRegPassword(e.target.value)} placeholder="Password (min 6 chars)" className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all"/>
                                        {regError&&<div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm animate-slide-in">{regError}</div>}
                                        <div className="flex gap-3">
                                            <button onClick={()=>setShowRegister(false)} className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg btn-hover">Cancel</button>
                                            <button onClick={handleRegister} className="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg btn-hover">Register</button>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                );
            }

            if(isLoading){
                return(
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-scale-in"><span className="text-white font-bold text-2xl">CPR</span></div>
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
                            <p className="text-gray-600">Loading...</p>
                        </div>
                    </div>
                );
            }

            if (screen === 'dashboard') {
                const stats = getDashboardStats();
                return (
                    <div className="min-h-screen bg-gray-50 page-transition">
                        <div className="bg-white shadow border-b">
                            <div className="max-w-7xl mx-auto px-4 py-3">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <LogOut size={18} />Logout
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                            <span className="text-white font-bold">CPR</span>
                                        </div>
                                        <div>
                                            <h1 className="text-2xl font-bold">Dashboard</h1>
                                            <p className="text-sm text-gray-600">Welcome, <span className="text-red-600 font-semibold">{currentUser.name}</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div className="bg-white rounded-xl shadow p-6 border-l-4 border-red-600 card-hover animate-fade-in">
                                    <div className="flex justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600">Total Batches</p>
                                            <p className="text-3xl font-bold">{stats.totalBatches}</p>
                                        </div>
                                        <Package className="text-red-600" size={40} />
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow p-6 border-l-4 border-green-600 card-hover animate-fade-in" style={{animationDelay: '0.1s'}}>
                                    <div className="flex justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600">Analyzed</p>
                                            <p className="text-3xl font-bold">{stats.analyzedBatches}</p>
                                        </div>
                                        <BarChart3 className="text-green-600" size={40} />
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow p-6 border-l-4 border-blue-600 card-hover animate-fade-in" style={{animationDelay: '0.2s'}}>
                                    <div className="flex justify-between">
                                        <div>
                                            <p className="text-sm text-gray-600">Revenue</p>
                                            <p className="text-3xl font-bold">${stats.totalRevenue.toFixed(2)}</p>
                                        </div>
                                        <DollarSign className="text-blue-600" size={40} />
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <button onClick={createNewBatch} className="bg-red-600 hover:bg-red-700 text-white p-6 rounded-xl shadow flex items-center gap-3 btn-hover">
                                    <Plus size={24} /><span className="font-semibold">New Batch</span>
                                </button>
                                <button onClick={() => setScreen('list')} className="bg-white hover:bg-gray-50 p-6 rounded-xl shadow flex items-center gap-3 border-2 btn-hover">
                                    <Package size={24} className="text-red-600" /><span className="font-semibold">All Batches</span>
                                </button>
                                <button onClick={() => setScreen('settings')} className="bg-white hover:bg-gray-50 p-6 rounded-xl shadow flex items-center gap-3 border-2 btn-hover">
                                    <Settings size={24} className="text-red-600" /><span className="font-semibold">Settings</span>
                                </button>
                                <button onClick={() => setScreen('users')} className="bg-white hover:bg-gray-50 p-6 rounded-xl shadow flex items-center gap-3 border-2 btn-hover">
                                    <Users size={24} className="text-red-600" /><span className="font-semibold">Users</span>
                                </button>
                            </div>
                            <div className="bg-white rounded-xl shadow p-6 animate-fade-in">
                                <h2 className="text-xl font-bold mb-4">Recent Batches</h2>
                                {stats.recentBatches.length === 0 ? (
                                    <div className="text-center py-12">
                                        <Package className="mx-auto mb-4 text-gray-400" size={48} />
                                        <p className="text-gray-500">No batches yet</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {stats.recentBatches.map(batch => (
                                            <div key={batch.id} className="flex justify-between p-4 bg-gray-50 rounded-lg hover:bg-red-50 transition-all card-hover">
                                                <div>
                                                    <p className="font-semibold text-red-600">{batch.batchNumber}</p>
                                                    <p className="text-sm text-gray-600">By {batch.createdBy} ‚Ä¢ {new Date(batch.createdAt).toLocaleDateString()}</p>
                                                </div>
                                                <div className="flex gap-2 items-center">
                                                    {batch.analysis && <span className="text-sm font-semibold text-green-600">${batch.analysis.optimalRevenue.toFixed(2)}</span>}
                                                    <button onClick={() => editBatch(batch)} className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm btn-hover">View</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'list') {
                return (
                    <div className="min-h-screen bg-gray-50 page-transition">
                        <div className="bg-white shadow border-b">
                            <div className="max-w-7xl mx-auto px-4 py-3">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <LogOut size={18} />Logout
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                            <span className="text-white font-bold">CPR</span>
                                        </div>
                                        <div>
                                            <h1 className="text-2xl font-bold">All Batches</h1>
                                            <p className="text-sm text-gray-600">{filteredBatches.length} batches</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setScreen('dashboard')} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <ArrowLeft size={18} />Back
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="flex gap-4 mb-6">
                                <div className="flex-1 relative">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                                    <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Search..." className="w-full pl-10 pr-4 py-3 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all" />
                                </div>
                                <button onClick={createNewBatch} className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold btn-hover">
                                    <Plus size={20} />New Batch
                                </button>
                            </div>
                            {filteredBatches.length === 0 ? (
                                <div className="bg-white rounded-xl shadow p-12 text-center border-t-4 border-red-600 animate-fade-in">
                                    <Package className="mx-auto text-gray-400 mb-4" size={48} />
                                    <h3 className="text-xl font-semibold">No batches found</h3>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredBatches.map((batch, idx) => (
                                        <div key={batch.id} className="bg-white rounded-xl shadow p-6 border-t-4 border-red-600 card-hover animate-fade-in" style={{animationDelay: `${idx * 0.05}s`}}>
                                            <div className="flex justify-between mb-4">
                                                <div>
                                                    <h3 className="text-lg font-bold text-red-600">{batch.batchNumber}</h3>
                                                    <p className="text-sm text-gray-600">By {batch.createdBy}</p>
                                                </div>
                                                {batch.analysis && <CheckCircle className="text-green-600" size={24} />}
                                            </div>
                                            <div className="mb-4 space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-gray-600">Created:</span>
                                                    <span>{new Date(batch.createdAt).toLocaleDateString()}</span>
                                                </div>
                                                {batch.analysis && (
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Revenue:</span>
                                                        <span className="font-bold text-green-600">${batch.analysis.optimalRevenue.toFixed(2)}</span>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => editBatch(batch)} className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm btn-hover">
                                                    <Edit2 size={16} />Edit
                                                </button>
                                                <button onClick={() => duplicateBatch(batch)} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg btn-hover transition-all">
                                                    <Copy size={16} />
                                                </button>
                                                <button onClick={() => deleteBatch(batch.id)} className="px-4 py-2 bg-gray-200 hover:bg-red-100 text-gray-700 hover:text-red-600 rounded-lg btn-hover transition-all">
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (screen === 'editor' && currentBatch) {
                const live = calculateLiveTotal();
                return (
                    <div className="min-h-screen bg-gray-50 page-transition">
                        <div className="bg-white shadow border-b">
                            <div className="max-w-7xl mx-auto px-4 py-3">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <LogOut size={18} />Logout
                                    </button>
                                </div>
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                            <span className="text-white font-bold">CPR</span>
                                        </div>
                                        <div>
                                            {isRenamingBatch ? (
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="text" 
                                                        value={tempBatchName} 
                                                        onChange={e => setTempBatchName(e.target.value)}
                                                        onKeyPress={e => e.key === 'Enter' && saveBatchName()}
                                                        className="text-2xl font-bold px-2 py-1 border-2 border-red-500 rounded focus:outline-none focus:ring-2 focus:ring-red-500"
                                                        autoFocus
                                                    />
                                                    <button onClick={saveBatchName} className="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-bold btn-hover">‚úì</button>
                                                    <button onClick={cancelRename} className="px-3 py-1 bg-gray-600 text-white rounded-lg text-sm font-bold btn-hover">‚úï</button>
                                                </div>
                                            ) : (
                                                <div className="flex items-center gap-2">
                                                    <h1 className="text-2xl font-bold">{currentBatch.batchNumber}</h1>
                                                    <button onClick={startRenamingBatch} className="text-blue-600 hover:text-blue-800 transition-colors" title="Rename batch">
                                                        <Edit2 size={18} />
                                                    </button>
                                                    {saveMessage && (
                                                        <span className={`text-sm ml-2 ${saveMessage.includes('‚úì') ? 'text-green-600' : 'text-gray-500'} animate-fade-in`}>
                                                            {saveMessage}
                                                        </span>
                                                    )}
                                                </div>
                                            )}
                                            <p className="text-sm">By <span className="text-red-600 font-semibold">{currentBatch.createdBy}</span></p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <p className="text-sm text-gray-600">Live Total</p>
                                            <p className="text-2xl font-bold text-blue-600">${live.toFixed(2)}</p>
                                        </div>
                                        <button onClick={() => setScreen('dashboard')} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                            <ArrowLeft size={18} />Back
                                        </button>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={runAnalysis} className="flex items-center gap-2 px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold btn-hover">
                                        <TrendingUp size={18} />Run Analysis
                                    </button>
                                    {currentBatch.analysis && (
                                        <button onClick={() => exportBatchAsPDF(currentBatch)} className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg btn-hover">
                                            <Download size={18} />Export PDF
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 bg-white rounded-xl shadow p-6 border-t-4 border-red-600 animate-fade-in">
                                    <h2 className="text-xl font-bold mb-4">Inventory Input</h2>
                                    <p className="text-sm text-gray-600 mb-4">Enter quantities - we'll find best supplier!</p>
                                    <div className="overflow-auto" style={{ maxHeight: '70vh' }}>
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-3 text-left">Model</th>
                                                    <th className="px-4 py-3 text-center text-red-600">OEM/Refurb</th>
                                                    <th className="px-4 py-3 text-center text-red-600">Aftermarket</th>
                                                    <th className="px-4 py-3 text-center">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {currentBatch.inventory.map((item, idx) => {
                                                    const oq = item.oem || 0;
                                                    const aq = item.aftermarket || 0;
                                                    let ob = 0;
                                                    let ab = 0;
                                                    suppliers.forEach(sup => {
                                                        const op = prices[`${item.model}_${sup.name}_OEM/Refurb`] || 0;
                                                        const ap = prices[`${item.model}_${sup.name}_Aftermarket`] || 0;
                                                        if (op > ob) ob = op;
                                                        if (ap > ab) ab = ap;
                                                    });
                                                    const rt = (ob * oq) + (ab * aq);
                                                    return (
                                                        <tr key={idx} className="border-t hover:bg-red-50 transition-colors">
                                                            <td className="px-4 py-3 font-medium">{item.model}</td>
                                                            <td className="px-4 py-3">
                                                                <div className="flex flex-col items-center gap-1">
                                                                    <input type="number" min="0" step="1" value={oq} onChange={e => updateQuantity(idx, 'oem', e.target.value)} className="w-24 px-3 py-2 border rounded-lg text-center focus:ring-2 focus:ring-red-500 transition-all" />
                                                                    {oq > 0 && <div className="text-xs text-green-600 font-semibold animate-fade-in">${ob.toFixed(2)} √ó {oq} = ${(ob * oq).toFixed(2)}</div>}
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-3">
                                                                <div className="flex flex-col items-center gap-1">
                                                                    <input type="number" min="0" step="1" value={aq} onChange={e => updateQuantity(idx, 'aftermarket', e.target.value)} className="w-24 px-3 py-2 border rounded-lg text-center focus:ring-2 focus:ring-red-500 transition-all" />
                                                                    {aq > 0 && <div className="text-xs text-green-600 font-semibold animate-fade-in">${ab.toFixed(2)} √ó {aq} = ${(ab * aq).toFixed(2)}</div>}
                                                                </div>
                                                            </td>
                                                            <td className="px-4 py-3 text-center">{rt > 0 && <span className="font-bold text-blue-600">${rt.toFixed(2)}</span>}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div className="bg-white rounded-xl shadow p-6 border-t-4 border-red-600 animate-fade-in" style={{animationDelay: '0.1s'}}>
                                    <h2 className="text-xl font-bold mb-4">Analysis</h2>
                                    {currentBatch.analysis ? (
                                        <div className="space-y-4">
                                            <div className="bg-green-50 border-l-4 border-green-600 p-4 rounded animate-slide-in">
                                                <p className="text-sm text-green-800 font-medium">Optimal Revenue</p>
                                                <p className="text-3xl font-bold text-green-700">${currentBatch.analysis.optimalRevenue.toFixed(2)}</p>
                                            </div>
                                            <div>
                                                <h3 className="font-semibold mb-3">Supplier Breakdown</h3>
                                                {Object.entries(currentBatch.analysis.supplierTotals).filter(([_, t]) => t > 0).sort((a, b) => b[1] - a[1]).map(([sup, tot], idx) => {
                                                    const itms = currentBatch.analysis.supplierAllocations[sup] || [];
                                                    return (
                                                        <div key={sup} className="mb-4 p-3 bg-gray-50 rounded border card-hover animate-slide-in" style={{animationDelay: `${idx * 0.1}s`}}>
                                                            <div className="flex justify-between mb-2">
                                                                <span className="font-semibold">{sup}</span>
                                                                <span className="font-bold text-red-600">${tot.toFixed(2)}</span>
                                                            </div>
                                                            {itms.map((it, i) => (
                                                                <div key={i} className="text-xs text-gray-600 flex justify-between">
                                                                    <span>{it.model} ({it.quality})</span>
                                                                    <span>{it.quantity}√ó${it.price.toFixed(2)}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            <div className="bg-blue-50 p-4 rounded text-center animate-scale-in">
                                                <CheckCircle className="mx-auto mb-2 text-blue-600" size={32} />
                                                <p className="text-sm font-semibold text-blue-800">Complete</p>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12">
                                            <TrendingUp className="mx-auto mb-4 text-gray-400" size={48} />
                                            <p className="text-gray-500">Run analysis</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'settings') {
                return (
                    <div className="min-h-screen bg-gray-50 page-transition">
                        <div className="bg-white shadow border-b">
                            <div className="max-w-7xl mx-auto px-4 py-3">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <LogOut size={18} />Logout
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                            <span className="text-white font-bold">CPR</span>
                                        </div>
                                        <h1 className="text-2xl font-bold">Settings</h1>
                                    </div>
                                    <button onClick={() => setScreen('dashboard')} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <ArrowLeft size={18} />Back
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="bg-white rounded-t-xl shadow border-b">
                                <div className="flex gap-2 p-2">
                                    <button onClick={() => setSettingsTab('prices')} className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${settingsTab === 'prices' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>üí∞ Prices</button>
                                    <button onClick={() => setSettingsTab('models')} className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${settingsTab === 'models' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>üì± Models</button>
                                    <button onClick={() => setSettingsTab('suppliers')} className={`flex-1 py-3 px-4 rounded-lg font-semibold transition-all ${settingsTab === 'suppliers' ? 'bg-red-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`}>üè¢ Suppliers</button>
                                </div>
                            </div>
                            {settingsTab === 'prices' && (
                                <div className="bg-white rounded-b-xl shadow p-6 animate-fade-in">
                                    {/* Excel Upload Section */}
                                    <div className="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                                        <div className="flex items-start gap-4">
                                            <div className="flex-1">
                                                <h3 className="font-bold text-blue-800 mb-2">üì§ Upload Excel to Update Prices</h3>
                                                <p className="text-xs text-blue-700 mb-2">
                                                    Your Excel file should have these columns:
                                                </p>
                                                <p className="text-xs font-mono bg-white px-3 py-2 rounded border border-blue-300 text-blue-900 mb-3">
                                                    Model | Injured Gadgets | Mobile Sentrix OEM | Mobile Sentrix AM | Phone LCD
                                                </p>
                                                <div className="flex items-center gap-3">
                                                    <input 
                                                        type="file" 
                                                        accept=".xlsx,.xls"
                                                        onChange={handleExcelUpload}
                                                        disabled={isUploadingExcel}
                                                        className="text-sm"
                                                        id="excel-upload"
                                                    />
                                                    <label htmlFor="excel-upload" className="cursor-pointer px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold btn-hover">
                                                        Choose File
                                                    </label>
                                                    {uploadMessage && (
                                                        <span className={`text-sm font-semibold ${uploadMessage.includes('‚úÖ') ? 'text-green-600' : uploadMessage.includes('‚ùå') ? 'text-red-600' : 'text-blue-600'} animate-fade-in`}>
                                                            {uploadMessage}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-xs text-gray-600 mt-2 italic">
                                                    üí° N/A values will be treated as $0.00
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex justify-between mb-4">
                                        <h2 className="text-xl font-bold">Prices</h2>
                                        <div className="text-sm text-gray-600 italic">Auto-saves when you click away from a field</div>
                                    </div>
                                    
                                    {/* Category Tabs for Prices */}
                                    <div className="flex gap-2 mb-4 border-b-2">
                                        <button 
                                            onClick={() => setPriceCategory('iPhone')}
                                            className={`px-6 py-2 font-semibold transition-all ${priceCategory === 'iPhone' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± iPhone
                                        </button>
                                        <button 
                                            onClick={() => setPriceCategory('Samsung')}
                                            className={`px-6 py-2 font-semibold transition-all ${priceCategory === 'Samsung' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± Samsung
                                        </button>
                                        <button 
                                            onClick={() => setPriceCategory('Google')}
                                            className={`px-6 py-2 font-semibold transition-all ${priceCategory === 'Google' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± Google
                                        </button>
                                        <button 
                                            onClick={() => setPriceCategory('All')}
                                            className={`px-6 py-2 font-semibold transition-all ${priceCategory === 'All' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üìã All Devices
                                        </button>
                                    </div>
                                    
                                    <div className="overflow-auto" style={{ maxHeight: '600px' }}>
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-3 text-left sticky left-0 bg-gray-50">Model</th>
                                                    {editSuppliers.map(sup => <th key={sup.name} colSpan={2} className="px-4 py-3 text-center border-l">{sup.name}</th>)}
                                                </tr>
                                                <tr className="bg-gray-100">
                                                    <th className="sticky left-0 bg-gray-100"></th>
                                                    {editSuppliers.map(sup => sup.qualities.map(q => <th key={`${sup.name}_${q}`} className="px-2 py-2 text-xs text-red-600">{q}</th>))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {(priceCategory === 'All' ? editModels : getModelsByCategory(priceCategory)).map((mod, i) => (
                                                    <tr key={i} className="border-t hover:bg-red-50 transition-colors">
                                                        <td className="px-4 py-2 font-medium sticky left-0 bg-white">{mod}</td>
                                                        {editSuppliers.map(sup => sup.qualities.map(q => {
                                                            const k = `${mod}_${sup.name}_${q}`;
                                                            return (
                                                                <td key={k} className="px-2 py-2 text-center">
                                                                    <input 
                                                                        type="number" 
                                                                        min="0" 
                                                                        step="1" 
                                                                        value={editPrices[k] || 0} 
                                                                        onChange={e => updatePrice(mod, sup.name, q, e.target.value)} 
                                                                        onBlur={() => handlePriceBlur(mod, sup.name, q)}
                                                                        className="w-20 px-2 py-1 border rounded text-center focus:ring-2 focus:ring-red-500 transition-all" 
                                                                    />
                                                                </td>
                                                            );
                                                        }))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                            {settingsTab === 'models' && (
                                <div className="bg-white rounded-b-xl shadow p-6 animate-fade-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold">Models</h2>
                                        <div className="text-sm text-gray-600 italic">Auto-saves when you add/remove</div>
                                    </div>
                                    
                                    {/* Category Tabs */}
                                    <div className="flex gap-2 mb-6 border-b-2">
                                        <button 
                                            onClick={() => setModelCategory('iPhone')}
                                            className={`px-6 py-2 font-semibold transition-all ${modelCategory === 'iPhone' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± iPhone
                                        </button>
                                        <button 
                                            onClick={() => setModelCategory('Samsung')}
                                            className={`px-6 py-2 font-semibold transition-all ${modelCategory === 'Samsung' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± Samsung
                                        </button>
                                        <button 
                                            onClick={() => setModelCategory('Google')}
                                            className={`px-6 py-2 font-semibold transition-all ${modelCategory === 'Google' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üì± Google
                                        </button>
                                        <button 
                                            onClick={() => setModelCategory('All')}
                                            className={`px-6 py-2 font-semibold transition-all ${modelCategory === 'All' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-600 hover:text-gray-800'}`}
                                        >
                                            üìã All Devices
                                        </button>
                                    </div>
                                    
                                    {/* Add Device Section */}
                                    <div className="flex gap-3 mb-6">
                                        <input 
                                            type="text" 
                                            value={newModel} 
                                            onChange={e => setNewModel(e.target.value)} 
                                            placeholder={`Add ${modelCategory === 'All' ? '' : modelCategory + ' '}device name`}
                                            className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all" 
                                            onKeyPress={e => e.key === 'Enter' && addModel()} 
                                        />
                                        <select 
                                            value={newDeviceCategory}
                                            onChange={e => setNewDeviceCategory(e.target.value)}
                                            className="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all"
                                        >
                                            <option value="iPhone">iPhone</option>
                                            <option value="Samsung">Samsung</option>
                                            <option value="Google">Google</option>
                                        </select>
                                        <button onClick={addModel} className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold btn-hover">Add</button>
                                    </div>
                                    
                                    {/* Models Grid - Filtered by Category */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                                        {(modelCategory === 'All' ? editModels : getModelsByCategory(modelCategory)).map((mod, i) => (
                                            <div key={i} className="flex justify-between items-center p-3 bg-gray-50 rounded border card-hover animate-fade-in" style={{animationDelay: `${i * 0.02}s`}}>
                                                <div>
                                                    <span className="font-medium">{mod}</span>
                                                    <div className="text-xs text-gray-500 mt-1">{getDeviceCategory(mod)}</div>
                                                </div>
                                                <button onClick={() => removeModel(mod)} className="text-red-600 hover:text-red-800 transition-colors"><Trash2 size={16} /></button>
                                            </div>
                                        ))}
                                        {modelCategory !== 'All' && getModelsByCategory(modelCategory).length === 0 && (
                                            <div className="col-span-3 text-center py-8 text-gray-500">
                                                No {modelCategory} devices yet. Add one above!
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            {settingsTab === 'suppliers' && (
                                <div className="bg-white rounded-b-xl shadow p-6 animate-fade-in">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-xl font-bold">Suppliers</h2>
                                        <div className="text-sm text-gray-600 italic">Auto-saves when you add/remove/edit</div>
                                    </div>
                                    <div className="flex gap-3 mb-6">
                                        <input type="text" value={newSupplierName} onChange={e => setNewSupplierName(e.target.value)} placeholder="Supplier name" className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 transition-all" onKeyPress={e => e.key === 'Enter' && addSupplier()} />
                                        <button onClick={addSupplier} className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold btn-hover">Add</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        {editSuppliers.map((sup, i) => {
                                            const isEditing = editingSupplier === sup.name;
                                            return (
                                                <div key={i} className="p-4 bg-gray-50 rounded border card-hover animate-fade-in" style={{animationDelay: `${i * 0.05}s`}}>
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex-1">
                                                            {isEditing ? (
                                                                <div className="flex gap-2">
                                                                    <input type="text" value={editSupplierName} onChange={e => setEditSupplierName(e.target.value)} className="flex-1 px-3 py-1 border-2 border-red-500 rounded-lg transition-all" autoFocus />
                                                                    <button onClick={saveSupplierNameEdit} className="px-3 py-1 bg-green-600 text-white rounded-lg text-sm font-bold btn-hover">‚úì</button>
                                                                    <button onClick={() => { setEditingSupplier(null); setEditSupplierName(''); }} className="px-3 py-1 bg-gray-600 text-white rounded-lg text-sm font-bold btn-hover">‚úï</button>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <h3 className="font-bold text-lg">{sup.name}</h3>
                                                                </div>
                                                            )}
                                                        </div>
                                                        {!editingSupplier && (
                                                            <div className="flex gap-2">
                                                                <button onClick={() => startEditingSupplier(sup)} className="text-blue-600 hover:text-blue-800 transition-colors" title="Edit name">
                                                                    <Edit2 size={18} />
                                                                </button>
                                                                <button onClick={() => removeSupplier(sup.name)} className="text-red-600 hover:text-red-800 transition-colors" title="Delete">
                                                                    <Trash2 size={18} />
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-800">
                                        üí° <strong>Tip:</strong> Changes save automatically. Click the pencil icon to edit supplier names.
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            if (screen === 'users') {
                return (
                    <div className="min-h-screen bg-gray-50 page-transition">
                        <div className="bg-white shadow border-b">
                            <div className="max-w-7xl mx-auto px-4 py-3">
                                <div className="flex justify-end mb-2">
                                    <button onClick={handleLogout} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <LogOut size={18} />Logout
                                    </button>
                                </div>
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center">
                                            <span className="text-white font-bold">CPR</span>
                                        </div>
                                        <h1 className="text-2xl font-bold">Users</h1>
                                    </div>
                                    <button onClick={() => setScreen('dashboard')} className="flex items-center gap-2 px-4 py-2 hover:bg-gray-100 rounded-lg btn-hover transition-all">
                                        <ArrowLeft size={18} />Back
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="bg-white rounded-xl shadow overflow-hidden animate-fade-in">
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b-2 border-red-600">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Name</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Email</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Username</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Role</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium uppercase">Created</th>
                                            {currentUser?.role === 'admin' && <th className="px-6 py-3 text-left text-xs font-medium uppercase">Actions</th>}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {users.map((u, idx) => (
                                            <tr key={u.id} className="hover:bg-red-50 transition-colors animate-fade-in" style={{animationDelay: `${idx * 0.05}s`}}>
                                                <td className="px-6 py-4 text-sm font-medium">{u.name}</td>
                                                <td className="px-6 py-4 text-sm text-gray-600">{u.email || 'N/A'}</td>
                                                <td className="px-6 py-4 text-sm">{u.username}</td>
                                                <td className="px-6 py-4 text-sm">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${u.role === 'admin' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}`}>
                                                        {u.role}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 text-sm">{new Date(u.createdAt).toLocaleDateString()}</td>
                                                {currentUser?.role === 'admin' && (
                                                    <td className="px-6 py-4 text-sm">
                                                        <button 
                                                            onClick={() => handlePasswordReset(u.id)}
                                                            className="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold btn-hover"
                                                        >
                                                            Reset Password
                                                        </button>
                                                    </td>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        // Render the app
        ReactDOM.render(<BuybackSystem />, document.getElementById('root'));
    </script>
</body>
</html>
